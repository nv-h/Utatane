# Utatane 包括的文字幅修正提案

⚠️ **注意**: このドキュメントは初期分析の結果です。最新の推奨案は `width_improvements.md` を参照してください。

## 問題の全体像

M+ 1mとUtataneの全グリフ比較により、**306件の幅不一致**を発見しました。
一致率は96.2%ですが、重要な文字種で大きな不整合があります。

**重要な発見**: 多くの不一致は**DataFrame表示のための意図的な設計判断**でした。

## 初期分析での修正カテゴリ

### 🔍 分析結果：DataFrame表示のための設計判断

#### 1. 罫線の半角化 (105件) - **現状維持推奨**
**現状**: 全ての罫線が1000→500に半角化されている
**判明した理由**: Polars等のDataFrame表示との互換性のため
```
例: ─ │ ┌ ┐ ═ ║ ╔ ╗ 等
設計意図: コンソール表示などで半角を期待されることが多かった
```

#### 2. 三点リーダーの半角化 (1件) - **現状維持推奨**
**現状**: 三点リーダーが1000→500に半角化されている
**判明した理由**: DataFrame内でのセル省略表現として使用
```
例: test/font_disp.txt で確認された用途
│ …        ┆ …          ┆ …      ┆ …       │
```

#### 3. ローマ数字の半角化 (13件) - **修正推奨**
**現状**: ローマ数字が1000→500に半角化されている
**判断**: DataFrame表示に影響しないため修正可能
```
例: Ⅰ Ⅱ Ⅴ Ⅹ Ⅼ Ⅽ Ⅾ ⅰ ⅱ ⅴ ⅹ ⅼ ⅽ ⅾ
```

### 🔧 その他の修正項目

#### 4. 特殊記号の不整合 (22件)
- **通貨記号** (7件): ₨ ₩ ₪ 等が500→1000
- **ギリシャ記号** (8件): ϒ ϓ ϔ ϖ 等が500→1000
- **一般句読点** (2件): ‐ ― が1000→500 (修正推奨)
- **数学演算子** (3件): ∥ ∦ ∼ が500→1000

#### 5. 拡張文字の不整合 (129件)
- **IPA音標文字** (14件): 音韻記号が500→1000
- **ラテン文字拡張** (40件): アクセント付き文字
- **合字** (3件): ﬀ ﬃ ﬄ が500→1000
- **その他** (72件): 様々な特殊文字

## 根本原因と修正戦略

### 原因1: フォント優先順位の問題
**現在の処理順序**:
1. Ubuntu Mono (欧文優先)
2. やさしさゴシック (日本語)
3. M+ 1m (補完・罫線)

**問題**: M+ 1mの文字幅を基準にすべきなのに、他フォントが優先されている

### 原因2: 不完全な文字種判定
**現在のif-else構造**:
```python
if g.encoding in HALFWIDTH_CJK_KANA:
    width = int(WIDTH//2)
elif g.encoding in FULLWIDTH_CODES:
    width = WIDTH
elif g.encoding in RULED_LINES:
    width = int(WIDTH//2)  # ← 問題
elif g.encoding in BLOCK_ELEMENTS:
    # 部分的な処理
else:
    # 不完全な推定処理 ← 多くの文字がここに落ちる
    if g.width > WIDTH * 0.7:
        width = WIDTH
    else:
        width = int(WIDTH//2)
```

## 包括的修正案

### 修正戦略1: M+ 1m基準の幅決定ロジック

```python
def get_mplus_width(encoding, mplus_font):
    """M+フォントから正しい幅を取得"""
    if encoding in mplus_font and mplus_font[encoding].isWorthOutputting:
        return mplus_font[encoding].width
    return None

# 各グリフの幅設定で使用
mplus_width = get_mplus_width(g.encoding, mplus_font)
if mplus_width is not None:
    width = mplus_width  # M+の幅を優先
else:
    # M+にない場合のみ従来ロジック適用
    if g.encoding in HALFWIDTH_CJK_KANA:
        width = int(WIDTH//2)
    elif g.encoding in FULLWIDTH_CODES:
        width = WIDTH
    # ...
```

### 修正戦略2: 詳細な文字種リスト定義

```python
# M+基準で全角とすべき文字
MPLUS_FULLWIDTH_CHARS = [
    # 罫線素片
    *list(range(0x2500, 0x257F+1)),
    # ローマ数字
    *list(range(0x2160, 0x217F+1)),
    # 一般句読点の一部
    0x2010, 0x2015, 0x2026,
    # その他M+で全角の記号
    # ...
]

# M+基準で半角とすべき文字
MPLUS_HALFWIDTH_CHARS = [
    # ASCII範囲
    *list(range(0x0020, 0x007F+1)),
    # 制御図記号
    *list(range(0x2400, 0x243F+1)),
    # その他M+で半角の記号
    # ...
]
```

### 修正戦略3: 段階的実装

#### 第1段階: 最重要項目の修正
1. **罫線の修正**: `RULED_LINES`の処理を`width = WIDTH`に変更
2. **ローマ数字の追加**: `FULLWIDTH_CODES`にローマ数字範囲を追加
3. **制御図記号の修正**: 新たに`HALFWIDTH_CONTROL_SYMBOLS`を定義

#### 第2段階: 一般的な修正
1. **特殊記号の個別対応**: 問題の記号を個別リストで管理
2. **fallbackロジックの改善**: M+基準の判定を優先

#### 第3段階: 完全対応
1. **全文字種の網羅**: 306件全ての不一致を個別に検証・修正

## 実装の優先度

| 優先度（初期分析） | 項目 | 件数 | 影響度 | 最新判断 |
|--------|------|------|--------|----------|
| ~~最高~~ | ~~罫線の全角化~~ | 105件 | ~~ターミナル表示の根本的改善~~ | **現状維持** |
| **高** | ローマ数字の全角化 | 13件 | 文書表示の改善 | **修正推奨** |
| ~~高~~ | ~~制御図記号の半角化~~ | 37件 | ~~制御文字表示の正常化~~ | **要検討** |
| **中** | 特定記号の個別対応 | 2件 | 細かな互換性向上 | **部分修正** |
| **低** | 拡張文字の対応 | 129件 | 特殊用途での改善 | **現状維持** |

## 期待される効果

- **ターミナル表示**: 罫線表示が正常になり、TUIアプリケーションが正しく表示される
- **文書表示**: ローマ数字や特殊記号の配置が整う
- **互換性**: M+ 1mとの完全な文字幅互換性を実現
- **保守性**: 明確な文字種判定ロジックで将来の拡張が容易に

## 注意事項

- 既存のレイアウトに依存するアプリケーションへの影響を考慮
- 段階的実装により、重要度の高い修正から適用可能
- M+ 1mフォントとの完全互換性を実現

---

## ⚠️ 重要：最新の推奨案について

このドキュメントは初期分析の結果です。その後の詳細調査により：

1. **罫線と三点リーダー**: DataFrame表示のための意図的な設計と判明 → **現状維持**
2. **ローマ数字**: DataFrame表示に影響しない → **修正推奨**
3. **特定記号**: M+準拠を重視 → **部分的修正推奨**

**最新の具体的な推奨案は `width_improvements.md` を参照してください。**