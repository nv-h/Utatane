# Utatane文字幅改善提案

## 概要

M+ 1mフォントとUtataneの文字幅比較により、**306件の不一致**を発見しました。しかし、多くは**DataFrame表示のための意図的な設計判断**であることが判明しました。本提案では、実用性を維持しつつ可能な改善を行います。

**一致率**: 96.2% (7,793/8,099グリフ)  
**不一致**: 3.8% (306グリフ)

## 最終推奨案：バランス型修正

### ✅ 修正対象（15件）

DataFrame表示に影響しない文字のみを修正し、M+との互換性を部分的に向上させます。

| 文字種 | 件数 | 修正内容 | 理由 |
|--------|------|----------|------|
| **ローマ数字** | 13件 | 500→1000に修正 | 文書表示の整合性向上 |
| **特定記号** | 2件 | 500→1000に修正 | M+準拠（‐ ―） |

### 🔒 現状維持（291件）

DataFrame表示の重要要素は現状のまま維持します。

| 文字種 | 件数 | 対応 | 理由 |
|--------|------|------|------|
| **罫線** | 105件 | 半角のまま | DataFrame表示の枠組み |
| **三点リーダー** | 1件 | 半角のまま | セル内省略表現 |
| **制御記号・その他** | 185件 | 現状維持 | 影響度低・個別対応 |

## 実装方法

### utatane.py への修正

```python
# 新しい定数を追加
ROMAN_NUMERALS = list(range(0x2160, 0x217F+1))  # ローマ数字
SPECIAL_PUNCTUATION = [0x2010, 0x2015]  # ‐ ―

# modify_and_save_jp関数内の幅設定部分を修正
elif g.encoding in ROMAN_NUMERALS:
    width = WIDTH  # ローマ数字は全角
elif g.encoding in SPECIAL_PUNCTUATION:
    width = WIDTH  # 特定句読点は全角
elif g.encoding in HALFWIDTH_CJK_KANA:
    width = int(WIDTH//2)
elif g.encoding in FULLWIDTH_CODES:
    width = WIDTH
elif g.encoding in RULED_LINES:
    width = int(WIDTH//2)  # 現状維持（DataFrame互換性優先）
# ... 以下既存のロジック
```

## 期待される効果

- **DataFrame表示**: 完全に現状維持（表示崩れなし）
- **文書表示**: ローマ数字等で整合性向上
- **M+互換性**: 96.2% → 約98%に向上
- **実用性**: 最大限に維持

---

## 補足情報

### DataFrame表示における設計判断の背景

#### 罫線の半角化
```python
# utatane.py:335 のコメント
# 罫線はM+へ置き換えて半角にする(コンソール表示などで半角を期待されることが多かった)
```

**意図**: Polars等のDataFrameライブラリとの互換性確保

#### 三点リーダーの半角化
`test/font_disp.txt` の23行目で示されているように、DataFrame内での省略表現として使用：
```
│ …        ┆ …          ┆ …      ┆ …       │
```

**意図**: セル内容の省略表現として、行末位置を正確に揃える

### M+ 1mとの全グリフ比較詳細

#### 不一致の内訳
| カテゴリ | 件数 | 主な問題 | 設計意図 |
|----------|------|----------|----------|
| **罫線** | 105件 | 1000→500（半角化） | DataFrame表示対応 |
| **制御図記号** | 37件 | 500→1000（全角化） | 判定ロジックの副作用 |
| **ローマ数字** | 13件 | 1000→500（半角化） | 判定ロジックの漏れ |
| **IPA音標文字** | 14件 | 500→1000（全角化） | 判定ロジックの副作用 |
| **ギリシャ文字** | 8件 | 特殊記号の不整合 | 判定ロジックの漏れ |
| **通貨記号** | 7件 | 500→1000（全角化） | 判定ロジックの副作用 |
| **一般句読点** | 6件 | 1000→500（半角化） | DataFrame表示対応 |
| **その他** | 116件 | 様々な不整合 | 判定ロジックの漏れ |

#### Unicode East Asian Width問題
罫線文字は**Ambiguous (A)**に分類されており、環境により半角/全角の扱いが異なることが根本的な問題です。

### Cicaプロジェクトとの実装比較

#### 共通点
- 文字幅閾値: 両方とも700を使用
- 2段階幅システム: Cica(512/1024), Utatane(500/1000)
- 基本的なアプローチは類似

#### Cicaの優れた実装（参考）
```python
# タイムスタンプ付きログ
def log(_str):
    now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    print(now + " " + _str)

# より直接的な文字幅調整
def align_to_center(_g):
    width = 1024 if _g.width > 700 else 512
    _g.width = width
    _g.left_side_bearing = _g.right_side_bearing = (_g.left_side_bearing + _g.right_side_bearing)/2
```

#### Utataneの独自の利点
- より詳細なフォントメトリクス設定
- M+ 1mとの統合による統一感
- 明確な文字種分類定数

### ラテン文字・ギリシャ文字・キリル文字について

#### 現状分析結果

✅ **良好な状況**:
- 基本ラテン文字、拡張ラテン文字、ギリシャ文字、キリル文字はすべて適切に処理済み
- M+ 1mとUbuntu Monoの両方で文字幅500（半角）で統一されている
- 現在のUtataneでも正しく幅500で実装されている

#### 文字範囲の詳細
| 文字範囲 | M+での幅 | Ubuntu Monoでの幅 | Utataneでの幅 | 状態 |
|----------|----------|-------------------|---------------|------|
| 基本ラテン文字 (0x0080-0x00FF) | 500 | 500 | 500 | ✅ 問題なし |
| 拡張ラテン文字A (0x0100-0x017F) | 500 | 500 | 500 | ✅ 問題なし |
| 拡張ラテン文字B (0x0180-0x024F) | 500 | 500 | 500 | ✅ 問題なし |
| ギリシャ文字 (0x0370-0x03FF) | 500 | 500 | 500 | ✅ 問題なし |
| キリル文字 (0x0400-0x04FF) | 500 | 500 | 500 | ✅ 問題なし |

### 記号類の描画ずれ問題

#### 良好な状況の記号類
- **幾何図形**: ○●△▲□■◇◆ (全て適切な1000幅)
- **囲み数字**: ①②③④⑤⑨⑩ (全て適切な1000幅)
- **チェック・星印**: ✓✔✗✘★☆ (全て適切な1000幅)
- **矢印**: ←→⇐⇒ (全て適切な1000幅)
- **演算記号**: ×÷± (全て適切な500幅)

#### 修正対象の記号（本提案で対応）
| 記号 | 名前 | 現在の幅 | 修正後幅 | 影響 |
|------|------|----------|----------|------|
| `Ⅰⅱⅴⅹ` | ローマ数字 | 500 | 1000 | 文書表示の改善 |
| `‐―` | 句読点 | 500 | 1000 | M+準拠 |

### 将来の拡張案

#### 設定可能な仕様（将来検討）
```python
BOX_DRAWING_MODE = "console_optimized"  # default (現在仕様)
# BOX_DRAWING_MODE = "mplus_compatible"  # M+完全準拠
# BOX_DRAWING_MODE = "user_defined"      # カスタム設定
```

#### フォントバリアント案
- `Utatane-Regular.ttf` (現在仕様：DataFrame対応)
- `Utatane-MPlus.ttf` (M+完全互換版)
- `Utatane-Console.ttf` (コンソール最適化版)

## 注意点

- 既存のレイアウトに依存したコードがある場合は影響を受ける可能性
- DataFrame表示の要求を最優先に考慮した設計判断
- M+ 1mとの完全互換性よりも実用性を重視